{% extends "base.html" %}

{% block header %}
	<script>
		var my_var = "{{ usuario.username }}";
	</script>
{% endblock %}

{% block contenido_body %}

<!-- pop-up para la subida de archivos -->
<div id='popup' class='popup'>
	<div id="div_popup" class='popuptext'>
		<!-- Código insertado desde javascript  -->
	</div>
</div>

<!-- Añadir el botón para cambiar a vista lista/cuadricula -->
<p class="pull-right visible-xs">
    <button id="bt_offcanvas" type="button" class="btn btn-primary btn-xs" data-toggle="offcanvas">Mostrar opciones</button>
</p>
<div id="cambiar_vista">
    <!-- Código insertado desde javascript  -->
</div>

<div id="vista_documentos" class="col-xs-10 col-md-10 col-lg-10">
    <!-- Código insertado desde javascript  -->
</div> <!-- vista_documentos -->

<div class="col-xs-6 col-sm-2" id="sidebar">
	<input type="file" id="upload" name="upload" style="visibility: hidden" multiple />
	<ul class="nav nav-pills nav-stacked row-offcanvas row-offcanvas-right sidebar-offcanvas">
		<li class="active"><a href="#">Opciones</a></li>
		<li class="barra"><a href="" onclick="document.getElementById('upload').click(); return false">Subir archivo</a></li>
		<li class="barra"><a href="#">Crear carpeta</a></li>
	</ul>

	<form action="{{ request.build_absolute_uri }}upload/" method="POST" enctype="multipart/form-data">
		{% csrf_token %} 
		<input type="file" name="file"/>
		<br />
		<input type="submit" value="Upload File" />
	</form>
</div>

<script type="text/javascript">
	/******************* VISTA DE DOCUMENTOS *******************/

    //localStorage.setItem("modo_vista", "lista");
    //localStorage.getItem("modo_vista");
    actualizaVista();
    
    $("#cambiar_vista").on("click","#vista_cuadricula", function(){
        localStorage.setItem("modo_vista", "cuadricula");
        actualizaVista();
    });

    $("#cambiar_vista").on("click","#vista_lista", function(){
        localStorage.setItem("modo_vista", "lista");
        actualizaVista();
    });

    function actualizaVista(){
        var html = "";
        var username = "{{ usuario.username }}";
		getArchivos(username);

        if (localStorage.getItem("modo_vista") == "cuadricula"){
            html = "<span id='vista_lista' title='ver lista' class='glyphicon glyphicon-th-list'></span>";
            vistaCuadricula();
        }
        else{ 
            html = "<span id='vista_cuadricula' title='ver iconos' class='glyphicon glyphicon-th-large'></span>";
            vistaLista();
        }

        document.getElementById('cambiar_vista').innerHTML = html;
    }

    //Función que se encarga de pedir y recibir los archivos del usuario
    function getArchivos(_username) {
        $.ajax({
            url : "{% url 'getArchivos' %}",
            data : {
                
            },
            type : 'GET',
            dataType: 'json',
            success : function(datos){
                vistaLista(datos);
            },
            failure : function(datos){
                alert("Error: no se pudo realizar la consulta");
            },
            complete : function(datos) {
                console.log('Petición realizada');
            }
     	});
    }

    function vistaCuadricula(){
        var html = "" +
            "<div class='container-fluid cuadricula'>" +
                "<div class='row'>" +
                    "<div id='documento_vista_cuadricula' class='col-xs-4 col-md-3 col-lg-2'>" +
                        "<div id='archivo_1' title='Carpeta 1'>" +
                            "<img src='/static/images/folder.png'>" +
                            "<h5>Carpeta 1</h5>" +
                        "</div>" +
                    "</div>" +
                    "<div id='documento_vista_cuadricula' class='col-xs-4 col-md-3 col-lg-2'>" +
                        "<div id='archivo_2'>" +
                            "<img src='/static/images/folder.png'>" +
                            "<h5>Carpeta 2<span class='glyphicon glyphicon-star'></h5>" +
                        "</div>" +
                    "</div>" +
                    "<div id='documento_vista_cuadricula' class='col-xs-4 col-md-3 col-lg-2'>" +
                        "<div id='archivo_3'>" +
                            "<img src='/static/images/folder.png'>" +
                            "<h5>Carpeta 3</h5>" +
                        "</div>" +
                    "</div>" +
                    "<div id='documento_vista_cuadricula' class='col-xs-4 col-md-3 col-lg-2'>" +
                        "<div id='archivo_4'>" +
                            "<img src='/static/images/folder.png'>" +
                            "<h5>Carpeta 4</h5>" +
                        "</div>" +
                    "</div>" +
                    "<div id='documento_vista_cuadricula' class='col-xs-4 col-md-3 col-lg-2'>" +
                        "<div id='archivo_5'>" +
                            "<img src='/static/images/folder.png'>" +
                            "<h5>Carpeta 5</h5>" +
                        "</div>" +
                    "</div>" +
                    "<div id='documento_vista_cuadricula' class='col-xs-4 col-md-3 col-lg-2'>" +
                        "<div id='archivo_6'>" +
                            "<img src='/static/images/files_icons/icon_file_music.png'>" +
                            "<h5>cancion.mp3<span class='glyphicon glyphicon-star'></h5>" +
                        "</div>" +
                    "</div>" +
                    "<div id='documento_vista_cuadricula' class='col-xs-4 col-md-3 col-lg-2'>" +
                        "<div id='archivo_7'>" +
                            "<img src='/static/images/files_icons/icon_file_img.png'>" +
                            "<h5>imagen.png</h5>" +
                        "</div>" +
                    "</div>" +
                    "<div id='documento_vista_cuadricula' class='col-xs-4 col-md-3 col-lg-2'>" +
                        "<div id='archivo_8'>" +
                            "<img src='/static/images/files_icons/icon_file_txt.png'>" +
                            "<h5>documento.txt<span class='glyphicon glyphicon-star'></h5>" +
                        "</div>" +
                    "</div>" +
                    "<div id='documento_vista_cuadricula' class='col-xs-4 col-md-3 col-lg-2'>" +
                        "<div id='archivo_vista_cuadricula'>" +
                            "<img src='/static/images/files_icons/icon_file_presentation.png'>" +
                            "<h5>presentacion.ppsx</h5>" +
                        "</div>" +
                    "</div>" +
                "</div>" +
            "</div> <!--> <!-- container -->";

        document.getElementById('vista_documentos').innerHTML = html;
        
        //Mostramos el menú si hacemos click derecho con el ratón
        $("div.row div").bind("contextmenu", function(e){
            $("#menu").css({'display':'block', 'left':e.pageX, 'top':e.pageY});
            return false;
        });

        //Acción al pulsar sobre un documento
        $("#documento_vista_cuadricula div").click(function( event ) {
            alert("Fila " + this.id);
        });
    }

    function vistaLista(datos){

        var html = "" +
            "<div class='table-responsive'>" +
                "<table id='tabla' class='table'>" +
                    "<thead>" +
                        "<tr>" +
                            "<th>Nombre archivo</th>" +
                            "<th>Tamaño</th>" +
                            "<th>Última modificación</th>" +
                            "<th>Disponible para</th>" +
                            "<th class='hidden-xs'>Opciones</th>" +
                        "</tr>" +
                    "</thead>" +
                    "<tbody>";
                    for (var i in datos) {
                        html += "<tr id='" + datos[i][0] + "'>" +
                            "<td><img src='/static/images/folder_lista.png' class='img-rounded img_lista'>" + datos[i][1] + "</td>" +
                            "<td class='center'>1GB</td>" +
                            "<td class='center'>" + datos[i][3] + "</td>" +
                            "<td class='center'>Solo yo</td>" +
                            "<td class='hidden-xs'>" +
                                "<div class='btn-group'>" +
                                    "<button type='button' class='btn btn-info dropdown-toggle' data-toggle='dropdown'>" +
                                    "Más <span class='caret'></span>" +
                                    "</button>" +
                                    "<ul class='dropdown-menu' role='menu'>" +
                                        "<li><a href='#''>Descargar</a></li>" +
                                        "<li><a href='#''>Compartir</a></li>" +
                                        "<li><a href='#''>Copiar</a></li>" +
                                        "<li><a href='#''>Mover</a></li>" +
                                        "<li><a href='#''>Añadir a favoritos</a></li>" +
                                        "<li><a href='#'>Eliminar</a></li>" +
                                    "</ul>" +
                                "</div>" +
                            "</td>" +
                        "</tr>";
                    }
                    html += "</tbody>" +
                "</table>" +
            "</div> <!-- table-responsive -->";

        document.getElementById('vista_documentos').innerHTML = html;

        //Mostramos el menú si hacemos click derecho con el ratón
        $("tbody tr").bind("contextmenu", function(e){
            $("#menu").css({'display':'block', 'left':e.pageX, 'top':e.pageY});
            return false;
        });

        var bt_opciones_pulsado = 0;
        //Acción al pulsar sobre el botón de opciones en la fila
        $(".btn-group").click(function( event ) {
            bt_opciones_pulsado = 1;
        });

        //Acción al pulsar sobre una fila
        $("#tabla tr").click(function( event ) {
            event.preventDefault();
            if((!bt_opciones_pulsado) && (this.id != 0))
                alert("Fila " + this.id);
            bt_opciones_pulsado = 0;
        });
    }
    //localStorage.clear();
</script>
{% endblock %}